<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Review <%= universityName %></title>
    <link rel="stylesheet" href="/reviewForm_style.css">
    <!-- Font Awesome CDN for star icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body data-user-id="<%= userId %>">
    <nav>
        <ul>
            <li><a href="/">Home</a></li>
            <li><a href="/search" class="active">Universities</a></li>
            <li><a href="/review">Reviews</a></li>
            <li><a href="/calculator">Programs</a></li>
            <li class="profile-menu">
                <img src="/profile.png" alt="Profile" class="profile-icon">
                <div class="dropdown">
                    <button>Profile</button>
                    <button>Settings</button>
                    <form action="/login" method="post"><button type="submit">Logout</button></form>
                </div>
            </li>
        </ul>
    </nav>

    <div class="container">
        <h1>Leave a Review for <%= universityName %></h1>

        <form id="reviewForm" method="POST" action="/submit-review">
            <input type="hidden" name="universityId" value="<%= universityId %>">

            <div class="rating-group">
                <div class="rating-item">
                    <label>Overall</label>
                    <div class="stars">
                        <input type="radio" id="overall-5" name="overall" value="5" required>
                        <label for="overall-5" class="fas fa-star"></label>
                        <input type="radio" id="overall-4" name="overall" value="4">
                        <label for="overall-4" class="fas fa-star"></label>
                        <input type="radio" id="overall-3" name="overall" value="3">
                        <label for="overall-3" class="fas fa-star"></label>
                        <input type="radio" id="overall-2" name="overall" value="2">
                        <label for="overall-2" class="fas fa-star"></label>
                        <input type="radio" id="overall-1" name="overall" value="1">
                        <label for="overall-1" class="fas fa-star"></label>
                    </div>
                </div>

                <div class="rating-item">
                    <label>Academics</label>
                    <div class="stars">
                        <input type="radio" id="academics-5" name="academics" value="5" required>
                        <label for="academics-5" class="fas fa-star"></label>
                        <input type="radio" id="academics-4" name="academics" value="4">
                        <label for="academics-4" class="fas fa-star"></label>
                        <input type="radio" id="academics-3" name="academics" value="3">
                        <label for="academics-3" class="fas fa-star"></label>
                        <input type="radio" id="academics-2" name="academics" value="2">
                        <label for="academics-2" class="fas fa-star"></label>
                        <input type="radio" id="academics-1" name="academics" value="1">
                        <label for="academics-1" class="fas fa-star"></label>
                    </div>
                </div>

                <div class="rating-item">
                    <label>Food</label>
                    <div class="stars">
                        <input type="radio" id="food-5" name="food" value="5" required>
                        <label for="food-5" class="fas fa-star"></label>
                        <input type="radio" id="food-4" name="food" value="4">
                        <label for="food-4" class="fas fa-star"></label>
                        <input type="radio" id="food-3" name="food" value="3">
                        <label for="food-3" class="fas fa-star"></label>
                        <input type="radio" id="food-2" name="food" value="2">
                        <label for="food-2" class="fas fa-star"></label>
                        <input type="radio" id="food-1" name="food" value="1">
                        <label for="food-1" class="fas fa-star"></label>
                    </div>
                </div>

                <div class="rating-item">
                    <label>Safety</label>
                    <div class="stars">
                        <input type="radio" id="safety-5" name="safety" value="5" required>
                        <label for="safety-5" class="fas fa-star"></label>
                        <input type="radio" id="safety-4" name="safety" value="4">
                        <label for="safety-4" class="fas fa-star"></label>
                        <input type="radio" id="safety-3" name="safety" value="3">
                        <label for="safety-3" class="fas fa-star"></label>
                        <input type="radio" id="safety-2" name="safety" value="2">
                        <label for="safety-2" class="fas fa-star"></label>
                        <input type="radio" id="safety-1" name="safety" value="1">
                        <label for="safety-1" class="fas fa-star"></label>
                    </div>
                </div>
                
                <div class="rating-item">
                    <label>Party Scene</label>
                    <div class="stars">
                        <input type="radio" id="party-5" name="party" value="5" required>
                        <label for="party-5" class="fas fa-star"></label>
                        <input type="radio" id="party-4" name="party" value="4">
                        <label for="party-4" class="fas fa-star"></label>
                        <input type="radio" id="party-3" name="party" value="3">
                        <label for="party-3" class="fas fa-star"></label>
                        <input type="radio" id="party-2" name="party" value="2">
                        <label for="party-2" class="fas fa-star"></label>
                        <input type="radio" id="party-1" name="party" value="1">
                        <label for="party-1" class="fas fa-star"></label>
                    </div>
                </div>

                <div class="rating-item">
                    <label>Student Life</label>
                    <div class="stars">
                        <input type="radio" id="student_life-5" name="student_life" value="5" required>
                        <label for="student_life-5" class="fas fa-star"></label>
                        <input type="radio" id="student_life-4" name="student_life" value="4">
                        <label for="student_life-4" class="fas fa-star"></label>
                        <input type="radio" id="student_life-3" name="student_life" value="3">
                        <label for="student_life-3" class="fas fa-star"></label>
                        <input type="radio" id="student_life-2" name="student_life" value="2">
                        <label for="student_life-2" class="fas fa-star"></label>
                        <input type="radio" id="student_life-1" name="student_life" value="1">
                        <label for="student_life-1" class="fas fa-star"></label>
                    </div>
                </div>

                <div class="rating-item">
                    <label>Location</label>
                    <div class="stars">
                        <input type="radio" id="location-5" name="location" value="5" required>
                        <label for="location-5" class="fas fa-star"></label>
                        <input type="radio" id="location-4" name="location" value="4">
                        <label for="location-4" class="fas fa-star"></label>
                        <input type="radio" id="location-3" name="location" value="3">
                        <label for="location-3" class="fas fa-star"></label>
                        <input type="radio" id="location-2" name="location" value="2">
                        <label for="location-2" class="fas fa-star"></label>
                        <input type="radio" id="location-1" name="location" value="1">
                        <label for="location-1" class="fas fa-star"></label>
                    </div>
                </div>

            </div>
            
            <label>Your Review:</label>
            <textarea name="review" rows="4"></textarea>
            
            <button type="submit" class="button">Submit Review</button>
        </form>
        <div id="statusMessage" class="status-message"></div>
    </div>

    <script>
        const loggedInUserId = parseInt(document.body.dataset.userId);

        document.addEventListener('DOMContentLoaded', () => {
            const reviewForm = document.getElementById('reviewForm');
            const statusMessage = document.getElementById('statusMessage');

            /**
             * Handles the form submission by sending data to a server endpoint.
             * @param {Event} event The submit event object.
             */
            reviewForm.addEventListener('submit', async (event) => {
                event.preventDefault(); // Prevent default form submission

                const formData = new FormData(reviewForm);
                
                // Map the form data to the database table column names
                const reviewData = {
                    user_id: loggedInUserId,
                    university_id: parseInt(formData.get('universityId')),
                    rating: parseInt(formData.get('overall')),
                    body: formData.get('review'),
                    academics_rating: parseInt(formData.get('academics')),
                    food_rating: parseInt(formData.get('food')),
                    safety_rating: parseInt(formData.get('safety')),
                    party_scene_rating: parseInt(formData.get('party')),
                    student_life_rating: parseInt(formData.get('student_life')),
                    location_rating: parseInt(formData.get('location')),
                };
                
                console.log('Collected Review Data:', reviewData);

                // Display a loading message
                statusMessage.className = 'status-message';
                
                try {
                    // Send the data to a server-side endpoint
                    const response = await fetch('/submit-review', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(reviewData)
                    });

                    // Check if the server response was successful
                    if (response.ok) {
                        const result = await response.json();
                        console.log('Server response:', result);
                        statusMessage.className = 'status-message success';
                        alert('Review submitted successfully!');
                    } else {
                        // Handle server errors
                        const errorText = await response.text();
                        throw new Error(`Server responded with status: ${response.status}. Error: ${errorText}`);
                    }
                } catch (error) {
                    console.error('Error submitting review:', error);
                    statusMessage.className = 'status-message error';
                    statusMessage.textContent = 'Failed to submit review. Please try again.';
                }
            });
        });
    </script>
</body>
</html>